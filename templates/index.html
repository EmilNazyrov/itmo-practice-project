<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div id="sidebar">
        <div id="theme-toggle">
            <span id="theme-icon" onclick="toggleTheme()">üåô</span> –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É
        </div>
        <div class="filters">
            <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤–µ—Ä—Å–∏—è–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
            <div class="filter-group">
                <label for="version-filter">–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
                <select id="version-filter">
                    <option value="all">–í—Å–µ –≤–µ—Ä—Å–∏–∏</option>
                    {% for version in versions %}
                        <option value="{{ version }}">{{ version }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á -->
            <div class="filter-group">
                <label for="task-type-filter">–¢–∏–ø –∑–∞–¥–∞—á–∏:</label>
                <select id="task-type-filter">
                    <option value="all">–í—Å–µ —Ç–∏–ø—ã –∑–∞–¥–∞—á</option>
                    {% for task_type in task_types %}
                        <option value="{{ task_type }}">{{ task_type }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="main-content">
        <h1>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</h1>
        <div class="btn-group">
            <button class="btn active" onclick="showGraph('graph1', this)">–°–µ—Å—Å–∏–∏ –ø–æ –≤–µ—Ä—Å–∏—è–º</button>
            <button class="btn" onclick="showGraph('graph2', this)">–°—É–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</button>
            <button class="btn" onclick="showGraph('graph3', this)">–ó–∞–¥–∞—á–∏ –ø–æ —Ç–∏–ø–∞–º</button>
        </div>

        <div id="graph1" class="graph-container fade-in"></div>
        <div id="graph2" class="graph-container" style="display: none;"></div>
        <div id="graph3" class="graph-container" style="display: none;"></div>

        <div id="loading-spinner" class="loading-spinner"></div>
    </div>

    <script>
        const graphs = {
            graph1: {{ graph1 | safe }},
            graph2: {{ graph2 | safe }},
            graph3: {{ graph3 | safe }}
        };

        const versionFilter = document.getElementById('version-filter');
        const taskTypeFilter = document.getElementById('task-type-filter');
        let currentVersionFilter = 'all';
        let currentTaskTypeFilter = 'all';

        function showGraph(targetId, button) {
            document.querySelectorAll('.graph-container').forEach(div => {
                div.style.display = 'none';
                div.classList.remove('fade-in');
            });

            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const target = document.getElementById(targetId);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('fade-in'), 10);

            if (button) button.classList.add('active');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const icon = document.getElementById('theme-icon');
            icon.textContent = document.body.classList.contains('dark-theme') ? 'üåû' : 'üåô';
        }

        function applyFilters() {
            const filteredGraph1 = filterGraph1(graphs.graph1);
            const filteredGraph2 = graphs.graph2;  // –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filteredGraph3 = filterGraph3(graphs.graph3);

            Plotly.react('graph1', filteredGraph1.data, filteredGraph1.layout);
            Plotly.react('graph2', filteredGraph2.data, filteredGraph2.layout);
            Plotly.react('graph3', filteredGraph3.data, filteredGraph3.layout);
        }

        function filterGraph1(graph) {
            let filteredData = graph.data;

            if (currentVersionFilter !== 'all') {
                filteredData = filteredData.filter(item =>
                    item.meta?.[0] === String(currentVersionFilter)
                );
            }

            return { data: filteredData, layout: graph.layout };
        }

        function filterGraph3(graph) {
            let filteredData = graph.data;

            if (currentTaskTypeFilter !== 'all') {
                filteredData = filteredData.filter(item =>
                    item.meta?.[0] === currentTaskTypeFilter
                );
            }

            return { data: filteredData, layout: graph.layout };
        }

        versionFilter.addEventListener('change', () => {
            currentVersionFilter = versionFilter.value;
            applyFilters();
        });

        taskTypeFilter.addEventListener('change', () => {
            currentTaskTypeFilter = taskTypeFilter.value;
            applyFilters();
        });

        window.addEventListener('load', () => {
            document.getElementById('loading-spinner').style.display = 'block';
            for (const id in graphs) {
                Plotly.newPlot(id, graphs[id].data, graphs[id].layout);
            }
            document.getElementById('loading-spinner').style.display = 'none';
        });
    </script>
</body>
</html>
